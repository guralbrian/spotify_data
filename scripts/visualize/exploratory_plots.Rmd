---
title: "Listening history exploration"
author: "Brian Gural"
date: "2023-09-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown



```{r load libs}
libs <- c("tidyverse", "patchwork", "lubridate", "RColorBrewer", "pals", "ggridges", "viridis")
lapply(libs, require, character.only = T)
rm(libs)
```


```{r load data}
df <- read.csv("data/raw/individuals/rsharp/listen_history_1year.csv", row.names = 1)
```
```{r data cleaning}
df <- df %>%
  mutate(endTime = lubridate::ymd_hm(endTime),
         endTime = lubridate::with_tz(endTime, tzone = "America/New_York"),
         minute  = lubridate::minute(endTime),
         hour    = lubridate::hour(endTime),
         month   = lubridate::month(endTime, label = T),
         hoursPlayed = msPlayed / 3600000)

```
## Plots

You can also embed plots, for example:

```{r basic visuals, echo=FALSE}
# Get listening time by artist
p.total.artist <- df %>%
  group_by(artistName) %>%
  summarise(hr_played = sum(as.numeric(msPlayed)/(1000*60*60))) %>%
  arrange(desc(hr_played))%>%
  head(10) %>%
  ggplot(aes(x = reorder(artistName, hr_played), y = hr_played, fill = hr_played)) +
  geom_col() +
  coord_flip() +
  scale_fill_viridis() +
  xlab("Artist") +
  ylab("Total Hours Listened") +
  ggtitle("Total Listening Time Per Artist") +
  theme_minimal() +
  theme(
    legend.position = "none"
  )


# Plot listening habits by time of day
p.time.hourly <- df %>%
  count(hour) %>%
  ggplot(aes(x = hour, y = n, fill = n)) +
  geom_col() +
  scale_fill_viridis() +
  xlab("Hour of Day") +
  ylab("Frequency") +
  ggtitle("Tracks Started by Time of Day") +
  theme_minimal() +
  theme(
    legend.position = "none"
  )

# make custom palette 

# Plot top tracks     
p.top.tracks <- df |>
  group_by(trackName, artistName) |> 
  summarise(hr_played = sum(as.numeric(msPlayed)/(1000*60*60))) |> 
  ungroup() |> 
  slice_max(n = 25, order_by = hr_played) %>%
  ggplot(aes(x = reorder(trackName, hr_played), y = hr_played, fill = artistName)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values=as.vector(kelly(22))) +
  xlab("Track") +
  ylab("Hours listened") +
  ggtitle("Top 25 Most Listened Tracks") +
  theme_minimal()

# Plot monthly listening time
p.time.monthly <- df %>%
  group_by(month) %>%
  summarise(hr_played = sum(as.numeric(msPlayed)/(1000*60*60))) %>%
  ggplot(aes(x = month, y = hr_played, fill = hr_played)) +
  geom_col()  +
  scale_fill_viridis() +
  xlab("Month") +
  ylab("Hours Listened") +
  ggtitle("Cumulative Listening by Month") +
  theme_minimal() +
  theme(
    legend.position = "none"
  )



```



```{r plot intro graphs, fig.width= 6, fig.height=6}
top.artists <- df %>%
  group_by(artistName) %>%
  summarise(hr_played = sum(as.numeric(msPlayed)/(1000*60*60))) %>%
  arrange(desc(hr_played))%>%
  head(10) |> 
  pull(artistName)

p.daily.artists <- df |> 
  subset(artistName == top.artists) |> 
  mutate(time_of_day = as.numeric(hour) + as.numeric(minute/60)) |> 
  ggplot(aes(x = time_of_day, y = artistName, group = artistName)) +
    geom_density_ridges_gradient(aes(fill = artistName), alpha = 0.5, scale = 0.8) + 
    scale_fill_manual(values=as.vector(kelly(10))) +
    scale_x_continuous(breaks = c(0,6,12,18,24),
                     limits = c(0,24)) +
    labs(title = "Daily listening times of top artists",
       x = "Hour of Day", 
       y = NULL) +
    theme_minimal() +
    theme(
      strip.background = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.position = "none",
      panel.grid.minor = element_blank()
  )

p.alltime.artists <- df |> 
  subset(artistName %in% top.artists) |> 
  mutate(date = lubridate::date(endTime)) |> 
  group_by(artistName, date) |> 
  summarise(lisDailyHour = sum(as.numeric(msPlayed)/(1000*60*60)), .groups = "keep") |> 
  ggplot(aes(x = date, y = lisDailyHour, fill = artistName)) +
    geom_density(stat="density", alpha = 0.9) + 
    facet_wrap(~ artistName, scales = "free", ncol = 1,
             strip.position = "right") +
    scale_fill_manual(values=as.vector(kelly(10))) +
    labs(title = "Daily listening times of top artists",
       x = "Hour of Day", 
       y = NULL) +
    theme_minimal() +
    theme(
      strip.background = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.position = "none",
      panel.grid.minor = element_blank()
  )

p.alltime.artists.2 <-  df |> 
  subset(artistName %in% top.artists) |> 
  ggplot(aes(x = endTime, y = artistName, group = as.factor(artistName))) +
    geom_density_ridges(aes(fill = artistName), 
                        inherit.aes = T,
                        scale = 1.2) +
    scale_fill_manual(values=as.vector(kelly(10))) +
    scale_y_discrete(expand = c(0.01, 0)) +
    labs(title = "Play frequency of top artists over past year",
       x = "Date", 
       y = NULL) +
    theme_minimal() +
    theme(
      strip.background = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      legend.position = "none",
      panel.grid.minor = element_blank()
  )
```

```{r plot intro graphs, fig.width= 20, fig.height=8}
design <- "BAAE
           DCCE"
wrap_plots(A = p.time.monthly, B = p.time.hourly, C = p.top.tracks, D = p.total.artist, E = p.daily.artists, design = design)
```

```{r plot top artists, fig.width= 20, fig.height=8}
design <- "ABC"
wrap_plots(A = p.daily.artists, B = p.alltime.artists, C = p.alltime.artists.2, design = design)
```


