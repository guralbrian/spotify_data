---
title: "Attributes and listening correlations"
author: "Brian Gural"
date: "2023-09-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load libs}
# Load necessary libraries
libs <- c("tidyverse", "gplots", "viridis", "factoextra", "ggiraphExtra")
lapply(libs, require, character.only = T)
```

```{r load data}
lis.df <- read.csv( "data/list_attr/bg_1y_t100.csv")
```

```{r subset to metrics}

met.df <- lis.df |> 
          dplyr::select(
            track_name, min_played, artist_name, album_release_date, danceability, energy, key,
            loudness, mode, speechiness, acousticness, instrumentalness, liveness, valence, tempo)
```

```{r plot heatmap, fig.width=12, fig.height=12}
num.df <- met.df |> 
  dplyr::select(-track_name, -artist_name, -album_release_date) 

cor(num.df) |> 
  gplots::heatmap.2(col = "viridis", margins = c(10,10), trace = "none") 

```

```{r pca of attr, , fig.width=12, fig.height=12}
pca.df <- met.df |>  
  mutate(track_artist = paste(track_name, artist_name, sep = "_")) |> 
  group_by(track_artist) |> 
  slice_head(n = 1) |> 
  column_to_rownames("track_artist") |> 
  dplyr::select(-album_release_date, -artist_name, -track_name, -mode)  %>%
  ungroup() %>%
  mutate(across(everything(), as.numeric))

pca.out <- pca.df |> 
           dplyr::select(-min_played) |> 
           t() |> 
           stats::prcomp() 

summary(pca.out)

pca.out <- pca.out$rotation |>
          merge(pca.df, by = 0)


```

```{r plot pca, fig.width=12, fig.height=12}
top.tracks <- 

pca.df |> 
    ggplot(aes(x = PC1, y = PC2, size = min_played, color = danceability)) +
                  geom_point(alpha = 0.3) +
                  labs(title = "PCA of music attributes") +
                  theme(legend.position = "none") +
                  theme_minimal()
```



```{r yahma_yhmn model fit}

# Scale the data

scaled.df <- pca.df |> 
             dplyr::select(-min_played) |> 
             scale()

# Silhouette to find optimal cluster number
fviz_nbclust(x = scaled.df, 
             FUNcluster = kmeans,
             method = 'silhouette')

# its 2

```

```{r yahma kmeans}
scaled.km <- kmeans(x = scaled.df, centers = 3)

# Num of songs in each cluster
scaled.km$size

scaled.km$withinss


# Add info back 

pca.df$cluster <- scaled.km$cluster


fviz_cluster(object = scaled.km,
             data = pca.df, labelsize = 1)


ggiraphExtra::ggRadar(
  data=pca.df,
  mapping = aes(colours = cluster),
  interactive = T
)

```
```{r cluster details}
pca.df |> 
  rownames_to_column(var = "track_artist") |> 
  arrange(desc(min_played)) |> 
  group_by(cluster) |> 
  slice_head(n=3) 


  arrange(cyl, desc(mpg)) %>%
  group_by(cyl) %>%
  slice_head(n=3) %>%
  select(car, cyl, mpg, disp, hp)


```